<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ERM ACTUALLY — TV</title>
  <style>
    /* === TV LAYOUT === */
body{
  overflow: hidden;
}

/* barra giocatori in alto */
#playersBar{
  position: fixed;
  top: 0;
  left: 0;
  right: 320px; /* spazio per la chat a destra */
  height: 96px;
  padding: 10px 14px;
  z-index: 40;
  display: flex;
  gap: 10px;
  align-items: center;
  background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
  backdrop-filter: blur(8px);
}

/* area principale del gioco */
#main{
  position: absolute;
  top: 96px;       /* sotto la barra giocatori */
  left: 0;
  right: 320px;    /* lascia spazio alla chat */
  bottom: 0;
  padding: 12px;
}

/* colonna chat / webcam */
#sideChat{
  position: fixed;
  top: 0;
  right: 0;
  width: 320px;
  bottom: 0;
  background: rgba(0,0,0,.35);
  border-left: 2px solid rgba(255,255,255,.15);
  z-index: 30;
}
    :root{
      --bg1:#0a0b18;
      --bg2:#101235;
      --text:#f3f6ff;
      --muted: rgba(243,246,255,.70);

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.14);

      --c1:#22e6ff;
      --c2:#8b5cff;
      --c3:#2cff9a;

      --r:18px;
      --gap:12px;
    }

    html,body{ height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:
      radial-gradient(1000px 700px at 15% 0%, rgba(34,230,255,.35), transparent 60%),
      radial-gradient(900px 700px at 85% 0%, rgba(139,92,255,.32), transparent 55%),
      radial-gradient(900px 800px at 50% 100%, rgba(44,255,154,.18), transparent 55%),
      linear-gradient(180deg, var(--bg2), var(--bg1));
      color: var(--text);
      overflow:hidden;
    }

    .topbar{
      position:fixed; left:12px; right:12px; top:12px; z-index:30;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 14px;
      border-radius: calc(var(--r) + 2px);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .brand{ display:flex; align-items:baseline; gap:10px; min-width: 280px;}
    .brand .t{ font-weight:1000; letter-spacing:.6px; font-size: 18px; }
    .brand .s{ color: var(--muted); font-size: 12px; font-weight:700; letter-spacing:.3px; }
    .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex; gap:8px; align-items:center; font-size: 12px;
      padding: 7px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--muted);
    }
    button, .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.24);
      color: var(--text);
      padding: 9px 11px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      letter-spacing:.2px;
    }
    button:hover{ background: rgba(255,255,255,.08); }
    button:active{ transform: translateY(1px); }
    .danger{ border-color: rgba(255,120,120,.35); }
    .ok{ border-color: rgba(44,255,154,.35); }

    .scores{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      max-width: 60vw;
    }
    .player{
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 1px rgba(34,230,255,.07);
    }
    .pname{
      min-width: 90px;
      max-width: 150px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 900;
      font-size: 14px;
      outline:none;
    }
    .pscore{
      font-variant-numeric: tabular-nums;
      font-weight: 1000;
      font-size: 28px;
      letter-spacing:.5px;
      padding: 4px 10px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(34,230,255,.18), rgba(139,92,255,.12));
      border: 1px solid rgba(255,255,255,.14);
      min-width: 74px;
      text-align:center;
    }
    .mini{
      padding: 8px 10px;
      font-size: 18px;
      border-radius: 12px;
      background: rgba(0,0,0,.26);
    }
    .mini:hover{ background: rgba(255,255,255,.08); }
    .xbtn{ padding: 7px 9px; font-size: 14px; border-radius: 12px; opacity:.85; }
    .xbtn:hover{ opacity:1; }

    .stage{
      position:absolute; inset:0;
      padding: 92px 14px 14px 14px;
      box-sizing:border-box;
    }
    .boardCard{
      height: 100%;
      border-radius: calc(var(--r) + 6px);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .boardInner{ padding: 14px; flex:1; display:flex; flex-direction:column; }
    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 1.2fr repeat(5, 1fr);
      gap: 12px;
      align-items:stretch;
    }
    .cat{
      padding: 14px 14px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.10));
      border: 1px solid rgba(255,255,255,.16);
      font-weight: 1000;
      letter-spacing:.7px;
      display:flex; align-items:center;
      box-shadow: inset 0 0 0 1px rgba(139,92,255,.08);
    }
    .colh{
      padding: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 1000;
      font-size: 16px;
      text-align:center;
      display:flex; align-items:center; justify-content:center;
    }
    .cell{
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      border: 2px solid rgba(34,230,255,.22);
      text-align:center;
      font-size: 26px;
      font-weight: 1100;
      letter-spacing:.4px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 88px;
      user-select:none;
      box-shadow: 0 14px 40px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.10);
    }
    .cell:hover{ border-color: rgba(44,255,154,.35); transform: translateY(-1px); }
    .cell.used{
      opacity:.22;
      filter: grayscale(.15);
      text-decoration: line-through;
      border-color: rgba(255,255,255,.10);
      box-shadow: none;
      transform:none;
    }
    .hint{
      margin-top: 10px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      color: var(--muted);
      font-size: 12px;
    }

    #webcamCard{
      position: fixed;
      right: 14px;
      bottom: 14px;
      width: 260px;
      z-index: 40;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.25));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 20px 70px rgba(0,0,0,.35);
      overflow:hidden;
      display:none;
      backdrop-filter: blur(6px);
    }
    #webcamLabel{
      padding: 10px 12px;
      font-weight: 1000;
      letter-spacing:.4px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    video{ width:100%; max-height: 150px; background: rgba(0,0,0,.35); display:block; }
    .camBtns{ display:flex; gap:8px; padding: 10px; justify-content:space-between; }
    .camBtns button{ flex:1; padding: 8px 10px; font-size: 12px; border-radius: 12px; }

    .modalBackdrop{
      position:fixed; inset:0;
      background: radial-gradient(900px 700px at 20% 0%, rgba(34,230,255,.22), transparent 55%),
                  radial-gradient(900px 700px at 80% 0%, rgba(139,92,255,.22), transparent 55%),
                  rgba(0,0,0,.78);
      display:none; align-items:center; justify-content:center;
      z-index: 100;
    }
    .modal{
      width: 98vw;
      height: 96vh;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex; flex-direction:column;
      backdrop-filter: blur(10px);
    }
    .mHeader{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.14);
    }
    .mTitle{ display:flex; flex-direction:column; gap:4px; }
    .mTitle .small{ color: var(--muted); font-size: 12px; font-weight:900; letter-spacing:.35px;}
    .mTitle h2{ margin:0; font-size: 20px; letter-spacing:.3px; }
    .mActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .mBody{
      flex:1;
      padding: 16px;
      overflow:auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .bigBox{
      width: min(1200px, 96vw);
      padding: 26px 26px;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 1px rgba(34,230,255,.10);
    }
    .bigText{
      white-space: pre-wrap;
      font-size: clamp(26px, 2.3vw, 40px);
      line-height: 1.35;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .notes{ margin-top: 14px; color: var(--muted); font-size: 14px; }

    .settingsArea textarea{
      width:100%;
      min-height: 55vh;
      box-sizing:border-box;
      resize: vertical;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.18);
      color: var(--text);
      border-radius: 16px;
      padding: 12px 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px; line-height:1.35;
    }

    @media (max-width: 1100px){
      body{ overflow:auto; }
      .stage{ padding-top: 116px; }
      .grid{ grid-template-columns: 1fr repeat(3, 1fr); }
      #webcamCard{ position: static; width:auto; margin-top: 12px; }
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <div class="t" id="gameTitle">ERM ACTUALLY…</div>
    <div class="s" id="gameSubtitle">lovely made by yuu</div>
  </div>

  <div class="scores" id="scores"></div>

  <div class="actions">
    <span class="pill" id="usedCount">0/0 usate</span>
    <button id="btnAddPlayer" class="ok">+ Giocatore</button>
    <button id="btnReset" class="danger">Reset caselle</button>
    <button id="btnResetAll" class="danger">Reset tutto</button>
    <button id="btnSettings">Impostazioni</button>
  </div>
</div>

<div class="stage">
  <div class="boardCard">
    <div class="boardInner">
      <div id="board" class="grid"></div>
      <div class="hint">
        <div>Click su una casella → domanda. “Segna come usata” per farla sparire.</div>
        <div style="opacity:.8">Tip: premi <b>Esc</b> per chiudere. <b>Spazio</b> alterna domanda/risposta.</div>
      </div>
    </div>
  </div>
</div>

<div id="webcamCard">
  <div id="webcamLabel">Presentatore</div>
  <video id="video" playsinline autoplay muted></video>
  <div class="camBtns">
    <button id="btnCamOn" class="ok">Accendi</button>
    <button id="btnCamOff">Spegni</button>
    <button id="btnCamFlip">Camera</button>
  </div>
</div>

<div class="modalBackdrop" id="qBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mHeader">
      <div class="mTitle">
        <div class="small" id="qMeta">—</div>
        <h2 id="qTitle">—</h2>
      </div>
      <div class="mActions">
        <button id="btnToggleQA">Mostra risposta</button>
        <button id="btnMarkUsed" class="danger">Segna come usata</button>
        <button id="btnCloseQ">Chiudi</button>
      </div>
    </div>
    <div class="mBody">
      <div class="bigBox">
        <div class="bigText" id="qBigText">—</div>
        <div class="notes" id="qNotes"></div>
      </div>
    </div>
  </div>
</div>

<div class="modalBackdrop" id="sBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mHeader">
      <div class="mTitle">
        <div class="small">Impostazioni</div>
        <h2>Modifica e riusa il gioco</h2>
      </div>
      <div class="mActions">
        <button id="btnSaveSettings" class="ok">Salva</button>
        <button id="btnDownloadConfig">Scarica config</button>
        <label class="btn" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;">
          Carica config <input id="fileConfig" type="file" accept="application/json" style="display:none;">
        </label>
        <button id="btnCloseSettings">Chiudi</button>
      </div>
    </div>
    <div class="mBody settingsArea" style="align-items:stretch; justify-content:flex-start;">
      <textarea id="settingsJson" spellcheck="false"></textarea>
      <div class="notes">Suggerimento: modifica categorie, valori, domande, giocatori. Salva → aggiorna. Lo stato “usate” resta.</div>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = "ermActuallyTV.state.v1";
const CONFIG_KEY  = "ermActuallyTV.config.v1";

let config = null;
let state  = null;

const $ = (id)=>document.getElementById(id);

function defaultStateFromConfig(cfg){
  const used = {};
  for(const cat of cfg.categories){
    for(const val of cfg.values){
      used[`${cat.id}:${val}`] = false;
    }
  }
  return {
    used,
    players: (cfg.scoreboard?.players ?? []).map(p=>({name:p.name, score:p.score ?? 0})),
    webcam: { deviceId: null }
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadConfigFromStorage(){
  try{
    const raw = localStorage.getItem(CONFIG_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveConfigToStorage(cfg){
  localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
}
async function loadConfig(){
  const stored = loadConfigFromStorage();
  if(stored) return stored;
  const res = await fetch("./config.json", {cache:"no-store"});
  return await res.json();
}
function mergeStateWithConfig(){
  const fresh = defaultStateFromConfig(config);
  for(const k of Object.keys(fresh.used)){
    if(state?.used && k in state.used) fresh.used[k] = !!state.used[k];
  }
  if(Array.isArray(state?.players) && state.players.length){
    fresh.players = state.players.map(p=>({name:p.name ?? "Giocatore", score: Number(p.score)||0}));
  }
  if(state?.webcam?.deviceId) fresh.webcam.deviceId = state.webcam.deviceId;

  state = fresh;
  saveState();
}

function el(tag, attrs={}, text=null){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==="class") e.className = v;
    else if(k==="style") e.setAttribute("style", v);
    else e.setAttribute(k, v);
  }
  if(text!==null) e.textContent = text;
  return e;
}

function renderBoard(){
  const board = $("board");
  board.innerHTML = "";

  board.appendChild(el("div",{class:"cat", style:"justify-content:center; opacity:.85;"}, ""));
  for(const val of config.values){
    board.appendChild(el("div",{class:"colh"}, String(val)));
  }

  for(const cat of config.categories){
    board.appendChild(el("div",{class:"cat"}, cat.name));
    for(const val of config.values){
      const key = `${cat.id}:${val}`;
      const cell = el("button",{class:"cell","data-key":key, "aria-label": `${cat.name} ${val}`}, String(val));
      if(state.used[key]) cell.classList.add("used");
      cell.addEventListener("click", ()=>openQuestion(key));
      board.appendChild(cell);
    }
  }
  updateUsedCount();
}

function updateUsedCount(){
  const keys = Object.keys(state.used);
  const used = keys.filter(k=>state.used[k]).length;
  $("usedCount").textContent = `${used}/${keys.length} usate`;
}

function renderScores(){
  const wrap = $("scores");
  wrap.innerHTML = "";
  state.players.forEach((p, idx)=>{
    const row = el("div",{class:"player"});

    const name = el("input",{class:"pname", value: p.name});
    name.addEventListener("input", ()=>{
      state.players[idx].name = name.value;
      saveState();
    });

    const minus = el("button",{class:"mini"}, "−");
    const plus  = el("button",{class:"mini"}, "+");
    const score = el("div",{class:"pscore"}, String(p.score));

    const delta = ()=> currentQuestionValue() ?? 100;
    minus.addEventListener("click", ()=>applyDelta(idx, -delta(), score));
    plus.addEventListener("click", ()=>applyDelta(idx, +delta(), score));

    const remove = el("button",{class:"xbtn danger", title:"Rimuovi giocatore"}, "✕");
    remove.addEventListener("click", ()=>{
      if(confirm(`Rimuovere ${state.players[idx].name || "giocatore"}?`)){
        state.players.splice(idx,1);
        saveState();
        renderScores();
      }
    });

    row.append(name, minus, score, plus, remove);
    wrap.appendChild(row);
  });
}

function applyDelta(idx, d, scoreEl){
  state.players[idx].score = (Number(state.players[idx].score)||0) + d;
  scoreEl.textContent = String(state.players[idx].score);
  saveState();
}

function addPlayer(){
  const name = prompt("Nome giocatore:", `Giocatore ${state.players.length+1}`);
  if(!name) return;
  state.players.push({name, score:0});
  saveState();
  renderScores();
}

let openQKey = null;
let showingAnswer = false;

function currentQuestionValue(){
  if(!openQKey) return null;
  const v = Number(openQKey.split(":")[1]||0);
  return Number.isFinite(v) ? v : null;
}

function openQuestion(key){
  openQKey = key;
  showingAnswer = false;

  const [catId, val] = key.split(":");
  const cat = config.categories.find(c=>c.id===catId);
  const q = config.questions?.[key] ?? {prompt:"(incolla qui la domanda)", answer:"(incolla qui la risposta)", notes:""};

  $("qMeta").textContent = `${cat?.name ?? catId} • ${val}${config.currencyLabel ? " "+config.currencyLabel : ""}`;
  $("qTitle").textContent = "Domanda";
  $("qBigText").textContent = (q.prompt && q.prompt.trim()) ? q.prompt : "(vuoto)";
  $("qNotes").textContent = (q.notes && q.notes.trim()) ? q.notes : "";

  $("btnToggleQA").textContent = "Mostra risposta";
  $("qBackdrop").style.display = "flex";
}

function toggleQA(){
  if(!openQKey) return;

  const q = config.questions?.[openQKey] ?? {prompt:"", answer:"", notes:""};
  showingAnswer = !showingAnswer;

  if(showingAnswer){
    $("qTitle").textContent = "Risposta";
    $("qBigText").textContent = (q.answer && q.answer.trim()) ? q.answer : "(vuoto)";
    $("btnToggleQA").textContent = "Mostra domanda";
  }else{
    $("qTitle").textContent = "Domanda";
    $("qBigText").textContent = (q.prompt && q.prompt.trim()) ? q.prompt : "(vuoto)";
    $("btnToggleQA").textContent = "Mostra risposta";
  }
}

function closeQuestion(){
  $("qBackdrop").style.display = "none";
  openQKey = null;
  showingAnswer = false;
}

function setUsed(key, used){
  state.used[key] = used;
  saveState();
  const btn = document.querySelector(`.cell[data-key="${CSS.escape(key)}"]`);
  if(btn) btn.classList.toggle("used", used);
  updateUsedCount();
}

function openSettings(){
  $("settingsJson").value = JSON.stringify(config, null, 2);
  $("sBackdrop").style.display = "flex";
}
function closeSettings(){ $("sBackdrop").style.display = "none"; }

function saveSettingsFromTextarea(){
  try{
    const next = JSON.parse($("settingsJson").value);
    config = next;
    saveConfigToStorage(config);
    mergeStateWithConfig();

    $("gameTitle").textContent = config.title ?? "ERM ACTUALLY…";
    $("gameSubtitle").textContent = config.subtitle_fixed ?? "lovely made by yuu";

    applyWebcamConfig();
    renderScores();
    renderBoard();

    closeSettings();
  }catch(e){
    alert("JSON non valido: " + e.message);
  }
}

function downloadConfig(){
  const blob = new Blob([JSON.stringify(config, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "config.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function uploadConfigFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const next = JSON.parse(String(reader.result));
      config = next;
      saveConfigToStorage(config);
      mergeStateWithConfig();

      $("gameTitle").textContent = config.title ?? "ERM ACTUALLY…";
      $("gameSubtitle").textContent = config.subtitle_fixed ?? "lovely made by yuu";

      applyWebcamConfig();
      renderScores();
      renderBoard();

      closeSettings();
    }catch(e){
      alert("File JSON non valido: " + e.message);
    }
  };
  reader.readAsText(file, "utf-8");
}

function resetUsedOnly(){
  for(const k of Object.keys(state.used)) state.used[k] = false;
  saveState();
  renderBoard();
}
function resetAll(){
  if(!confirm("Reset totale? (caselle + punteggi)")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = defaultStateFromConfig(config);
  saveState();
  renderScores();
  renderBoard();
  stopCam();
}

let stream = null;
let facingMode = "user";

async function applyWebcamConfig(){
  const enabled = !!config.webcam?.enabled;
  $("webcamCard").style.display = enabled ? "block" : "none";
  $("webcamLabel").textContent = config.webcam?.label ?? "Presentatore";
  if(!enabled) stopCam();
  if(enabled && config.webcam?.defaultOn){
    await startCam();
  }
}
async function startCam(){
  if(!navigator.mediaDevices?.getUserMedia){
    alert("Browser non supporta webcam.");
    return;
  }
  stopCam();
  const constraints = config.webcam?.constraints ?? {video:true, audio:false};
  const videoConstraints = (constraints.video === true) ? {} : (constraints.video || {});
  if(state.webcam?.deviceId){
    videoConstraints.deviceId = {exact: state.webcam.deviceId};
  }else{
    videoConstraints.facingMode = facingMode;
  }
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: constraints.audio ?? false });
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings?.() || {};
    if(settings.deviceId){
      state.webcam.deviceId = settings.deviceId;
      saveState();
    }
    $("video").srcObject = stream;
  }catch(e){
    alert("Impossibile avviare webcam: " + e.message);
  }
}
function stopCam(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  $("video").srcObject = null;
}
async function flipCam(){
  state.webcam.deviceId = null;
  saveState();
  facingMode = (facingMode === "user") ? "environment" : "user";
  await startCam();
}

document.addEventListener("keydown", (e)=>{
  const qOpen = $("qBackdrop").style.display === "flex";
  const sOpen = $("sBackdrop").style.display === "flex";

  if(e.key === "Escape"){
    if(qOpen) closeQuestion();
    if(sOpen) closeSettings();
  }
  if(qOpen && e.code === "Space"){
    e.preventDefault();
    toggleQA();
  }
});

$("btnAddPlayer").addEventListener("click", addPlayer);
$("btnReset").addEventListener("click", resetUsedOnly);
$("btnResetAll").addEventListener("click", resetAll);

$("btnSettings").addEventListener("click", openSettings);
$("btnCloseSettings").addEventListener("click", closeSettings);
$("btnSaveSettings").addEventListener("click", saveSettingsFromTextarea);
$("btnDownloadConfig").addEventListener("click", downloadConfig);
$("fileConfig").addEventListener("change", (e)=>{ const f=e.target.files?.[0]; if(f) uploadConfigFile(f); e.target.value=""; });

$("btnToggleQA").addEventListener("click", toggleQA);
$("btnMarkUsed").addEventListener("click", ()=>{ if(openQKey) setUsed(openQKey,true); });
$("btnCloseQ").addEventListener("click", closeQuestion);
$("qBackdrop").addEventListener("click", (e)=>{ if(e.target === $("qBackdrop")) closeQuestion(); });

$("btnCamOn").addEventListener("click", startCam);
$("btnCamOff").addEventListener("click", stopCam);
$("btnCamFlip").addEventListener("click", flipCam);

(async function init(){
  config = await loadConfig();

  $("gameTitle").textContent = config.title ?? "ERM ACTUALLY…";
  $("gameSubtitle").textContent = config.subtitle_fixed ?? "lovely made by yuu";

  state = loadState();
  if(!state){
    state = defaultStateFromConfig(config);
    saveState();
  }else{
    mergeStateWithConfig();
  }

  renderScores();
  renderBoard();
  applyWebcamConfig();
})();
</script>
</body>
</html>
